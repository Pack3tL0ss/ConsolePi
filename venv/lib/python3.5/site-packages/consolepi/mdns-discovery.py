#!/etc/ConsolePi/venv/bin/python3 

""" Example of resolving a service with a known name """

import logging
import sys
import json
from consolepi.common import update_local_cloud_file
from consolepi.common import get_config
import threading

from zeroconf import Zeroconf

TYPE = '_http._tcp.local.'
NAME = 'ConsolePi'      
LOCAL_CLOUD_FILE = '/etc/ConsolePi/cloud.data'
DEBUG = get_config('debug')

def discover_remotes_mdns():
    zeroconf = Zeroconf()

    try:
       properties = zeroconf.get_service_info(TYPE, NAME + '.' + TYPE).properties

       hostname = properties[b'hostname'].decode("utf-8")
       user = properties[b'user'].decode("utf-8")
       interfaces = json.loads(properties[b'interfaces'].decode("utf-8"))
       adapters = json.loads(properties[b'adapters'].decode("utf-8"))
       data = {hostname: {'interfaces': interfaces, 'adapters': adapters, 'user': user}}
       threading.Thread(target=update_local_cloud_file, args=(LOCAL_CLOUD_FILE, data), name='avahi_local_cache_update').start()
    except AttributeError:
        pass
    finally:
        zeroconf.close()

    return data

if __name__ == '__main__':
    print(discover_remotes_mdns())

